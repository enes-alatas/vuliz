import {SonaTypeVulnerabilityProvider} from 'src/vulnerabilities/providers/sonatype_vulnerability_provider';
import {Package, PackageType} from 'src/packages/types';
import {Severity, Vulnerability} from 'src/vulnerabilities/types';

describe('SonaTypeVulnerabilityProvider', () => {
  let provider: SonaTypeVulnerabilityProvider;

  describe('addVulnerabilities', () => {
    it('should add vulnerabilities to NPM packages via API', async () => {
      provider = new SonaTypeVulnerabilityProvider(PackageType.NPM);
      const mockPackage: Package = {
        name: 'express',
        version: '1.0.1',
        vulnerabilityContainer: undefined,
      };
      const packages = await provider.addVulnerabilities([mockPackage]);
      const expectedVulns: Vulnerability[] = [
        {
          name: '[CVE-2024-29041] CWE-1286 CWE-601',
          cvssScore: 6.1,
          cveId: 'CVE-2024-29041',
          severity: Severity.Medium,
        },
        {
          name: "[CVE-2024-43796] CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
          cvssScore: 4.7,
          cveId: 'CVE-2024-43796',
          severity: Severity.Medium,
        },
      ];
      expect(packages[0].vulnerabilityContainer?.vulnerabilities).toMatchObject(
        expectedVulns,
      );
    });

    it('should add empty vulnerabilities for unknown packages', async () => {
      provider = new SonaTypeVulnerabilityProvider(PackageType.PYPI);
      const mockPackage: Package = {
        name: 'unknown',
        version: '1.2',
        vulnerabilityContainer: undefined,
      };
      const packages = await provider.addVulnerabilities([mockPackage]);
      expect(packages[0].vulnerabilityContainer).toBeUndefined();
    });

    it('should add vulnerabilities for multiple packages via API', async () => {
      provider = new SonaTypeVulnerabilityProvider(PackageType.PYPI);
      const mockPackages: Package[] = [
        {
          name: 'django',
          version: '1.2',
          vulnerabilityContainer: undefined,
        },
        {
          name: 'flask',
          version: '1.0.1',
          vulnerabilityContainer: undefined,
        },
      ];
      const packages = await provider.addVulnerabilities(mockPackages);
      const expectedVulnsDjango: Vulnerability[] = [
        {
          name: "[CVE-2010-3082] CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
          cvssScore: 4.3,
          cveId: 'CVE-2010-3082',
          severity: Severity.Medium,
        },
        {
          name: '[CVE-2010-4534] CWE-264: Permissions, Privileges, and Access Controls',
          cvssScore: 4.0,
          cveId: 'CVE-2010-4534',
          severity: Severity.Medium,
        },
        {
          name: "[CVE-2011-0698] CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
          cvssScore: 7.5,
          cveId: 'CVE-2011-0698',
          severity: Severity.High,
        },
      ];
      const expectedVulnsFlask: Vulnerability[] = [
        {
          name: '[CVE-2023-30861] CWE-539: Information Exposure Through Persistent Cookies',
          cvssScore: 7.5,
          cveId: 'CVE-2023-30861',
          severity: Severity.High,
        },
      ];

      if (packages[0].vulnerabilityContainer) {
        for (const expectedVuln of expectedVulnsDjango) {
          expect(
            packages[0].vulnerabilityContainer.vulnerabilities,
          ).toContainEqual(expectedVuln);
        }
      }

      expect(packages[1].vulnerabilityContainer?.vulnerabilities).toMatchObject(
        expectedVulnsFlask,
      );
    });
  });
});
